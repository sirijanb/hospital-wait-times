@page "/admin/hospitals/edit/{HospitalId:guid}"
@using HQS.Domain.Entities
@using HQS.Domain.Enums
@using HQS.Infrastructure.Services
@inject HospitalService HospitalService
@inject NavigationManager Nav
@attribute [Authorize(Roles = "MasterAdmin")]

<h3>Edit Hospital</h3>

@if (_hospital == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="_hospital" OnValidSubmit="UpdateHospital">
        <DataAnnotationsValidator />

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header fw-bold">Hospital Details</div>

                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Hospital Name</label>
                            <InputText class="form-control" @bind-Value="_hospital.Name" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <InputText class="form-control" @bind-Value="_hospital.Address" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Postal Code</label>
                            <InputText class="form-control" @bind-Value="_hospital.PostalCode" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Open Hours</label>
                            <InputText class="form-control" @bind-Value="_hospital.OpenHours" />
                        </div>

                        <div class="row">
                            <div class="col">
                                <label class="form-label">Total Beds</label>
                                <InputNumber class="form-control" @bind-Value="_hospital.TotalBeds" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Services Offered</label>

                            <div class="d-flex flex-wrap gap-3">
                                @foreach (var service in Enum.GetValues<ServiceType>())
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                            checked="@_hospital.ServicesOffered.Contains(service)"
                                            @onchange="e => OnServiceToggle(service, (bool)e.Value!)" />

                                        <label class="form-check-label">
                                            @service
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header fw-bold">Hospital Image</div>
                    <div class="card-body text-center">
                        @if (!string.IsNullOrWhiteSpace(_hospital.ImagePath))
                        {
                            <img src="@_hospital.ImagePath" class="img-thumbnail mb-2" />
                        }
                        else
                        {
                            <p class="text-muted fst-italic">
                                No image uploaded
                            </p>
                        }

                        <InputFile OnChange="OnImageSelected" />

                        @if (!string.IsNullOrEmpty(_imagePreview))
                        {
                            <img src="@_imagePreview" class="img-thumbnail mt-2" />
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button class="btn btn-success">Update</button>
            <button type="button" class="btn btn-outline-secondary ms-2" @onclick="Cancel">
                Cancel
            </button>
        </div>
    </EditForm>

}
@code {
    [Parameter] public Guid HospitalId { get; set; }

    private Hospital? _hospital = new() {
        ServicesOffered = new List<ServiceType>()
    };
    private IBrowserFile? _newImage;
    private string? _imagePreview;

    protected override async Task OnInitializedAsync()
    {
        _hospital = await HospitalService.GetByIdAsync(HospitalId);

        if (_hospital != null)
        {
            _hospital.ServicesOffered ??= new List<ServiceType>();
        }
    }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        _newImage = e.File;

        using var stream = _newImage.OpenReadStream(5_000_000);
        var buffer = new byte[_newImage.Size];
        await stream.ReadAsync(buffer);
        _imagePreview = $"data:{_newImage.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }

    private async Task UpdateHospital()
    {
        if (_hospital == null) return;

        await HospitalService.UpdateAsync(_hospital, _newImage);
        Nav.NavigateTo("/admin/hospitals");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/admin/hospitals");
    }

    void OnServiceToggle(ServiceType service, bool isChecked)
    {
        if (_hospital != null)
        {
            if (isChecked)
            {
                if (!_hospital.ServicesOffered.Contains(service))
                    _hospital.ServicesOffered.Add(service);
            }
            else
            {
                _hospital.ServicesOffered.Remove(service);
            }
        }
    }


}